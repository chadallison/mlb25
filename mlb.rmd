---
title: "Chad's 2025 MLB Report"
output: github_document
knit: (function(input, ...) { rmarkdown::render(input, output_file = "README.md", envir = globalenv()) })
---

*Interested in the underlying code that builds this report?* Check it out on GitHub: [mlb25](https://github.com/chadallison/mlb25){target="_blank"}

___

### Contents

- [Team Standings]
- [Runs Scored and Allowed per Game]
- [Run Differentials]
- [Pythagorean Wins]
- [Actual vs Pythagorean Win Percentages]
- [Winning and Losing Streaks]

___

```{r fold_code, include = F}
knitr::knit_hooks$set(source = function(x, options) {
    hook.r = function(x, options) {
      fence = "```"
      language = tolower(options$engine)
      if (language == "node") language = "javascript"
      if (!options$highlight) language = "text"
      if (!is.null(options$fold_code)) {
        paste0("\n\n", "<details><summary>View Code</summary>\n", fence, language,
               "\n", x, fence, "\n\n", "</details>\n")
      } else paste0('\n\n', fence, language, '\n', x, fence,  '\n\n')
    }
    x = knitr:::hilight_source(x, "markdown", options)
    hook.r(paste(c(x, ""), collapse = "\n"), options)
})
```

```{r message = F, warning = F, include = F, fold_code = T}
library(tidyverse)
library(tvthemes)
library(janitor)
library(glue)
library(zoo)
library(baseballr)

theme_custom = theme_avatar() +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5, size = 9, vjust = 2.5, face = "italic"),
        plot.caption = element_text(face = "italic"),
        panel.grid.major = element_line(linewidth = 0.5, colour = "#DFDAD1"),
        panel.grid.minor = element_line(linewidth = 0.5, colour = "#DFDAD1"))

theme_set(theme_custom)
```

```{r message = F, warning = F, include = F}
end_games_raw = mlb_schedule(season = 2025, level_ids = "1")

end_games = end_games_raw |>
  filter(series_description == "Regular Season" & status_detailed_state == "Final") |>
  select(date, game_pk, away_score = teams_away_score, away_team = teams_away_team_name,
         home_team = teams_home_team_name, home_score = teams_home_score) |>
  filter(!is.na(away_score) & !is.na(home_score)) |>
  mutate(win_team = ifelse(home_score > away_score, home_team, away_team),
         lose_team = ifelse(home_score > away_score, away_team, home_team),
         win_score = ifelse(home_score > away_score, home_score, away_score),
         lose_score = ifelse(home_score > away_score, away_score, home_score))

# writing and reading prevents baseballr message
write_csv(end_games, "data/end_games.csv")
end_games = read_csv("data/end_games.csv", show_col_types = F)
```

```{r include = F}
all_teams = sort(unique(c(end_games$home_team, end_games$away_team)))

team_abbrevs =  c(
  "ARI", "ATH", "ATL", "BAL", "BOS", "CHC",
  "CWS", "CIN", "CLE", "COL", "DET", "HOU",
  "KC", "LAA", "LAD", "MIA", "MIL", "MIN",
  "NYM", "NYY", "PHI", "PIT", "SD", "SF",
  "SEA", "STL", "TB", "TEX", "TOR", "WSH"
)


team_hex = c(
  "#A71930", "#003831", "#CE1141", "#DF4601", "#BD3039", "#0E3386",
  "#27251F", "#C6011F", "#0C2340", "#33006F", "#FA4616", "#EB6E1F",
  "#004687", "#BA0021", "#005A9C", "#00A3E0", "#FFC52F", "#D31145",
  "#002D72", "#003087", "#E81828", "#FDB827", "#2F241D", "#FD5A1E",
  "#0C2C56", "#C41E3A", "#8FBCE6", "#C0111F", "#134A8E", "#dcbdd0"
)


divisions <- c(
  "NL West", "AL West", "NL East", "AL East", "AL East", "NL Central",
  "AL Central", "NL Central", "AL Central", "NL West", "AL Central", "AL West",
  "AL Central", "AL West", "NL West", "NL East", "NL Central", "AL Central",
  "NL East", "AL East", "NL East", "NL Central", "NL West", "NL West",
  "AL West", "NL Central", "AL East", "AL West", "AL East", "NL East"
)


team_divisons = data.frame(team = all_teams, division = divisions) |>
  mutate(division = factor(division, levels = c("AL West", "AL Central", "AL East",
                                                "NL West", "NL Central", "NL East")))

teams_info = data.frame(team = all_teams, abb = team_abbrevs, hex = team_hex)

better_date = function(dt) {
  return(paste0(month(dt, label = T, abbr = F), " ", day(dt), ", ", year(dt)))
}
```

### Team Standings

```{r echo = F}
team_wins = end_games |>
  count(win_team, name = "wins")

team_losses = end_games |>
  count(lose_team, name = "losses")

team_records = team_wins |>
  full_join(team_losses, by = c("win_team" = "lose_team")) |>
  mutate(wins = coalesce(wins, 0),
         losses = coalesce(losses, 0),
         gp = wins + losses,
         win_pct = round(wins / gp * 100, 2),
         record = as.character(glue("{wins}-{losses}"))) |>
  rename(team = win_team) |>
  inner_join(teams_info, by = "team")

team_records |>
  ggplot(aes(reorder(reorder(team, win_pct), wins), win_pct)) +
  geom_col(aes(fill = team), show.legend = F) +
  geom_text(aes(label = record), size = 3, hjust = -0.2) +
  coord_flip(ylim = c(0, max(team_records$win_pct) * 1.05)) +
  scale_fill_manual(values = team_hex) +
  labs(x = NULL, y = NULL, title = "2025 MLB Standings") +
  theme(axis.text.x = element_blank())
```

___

### Runs Scored and Allowed per Game

```{r echo = F}
home_scored_allowed = end_games |>
  select(date, team = home_team, scored = home_score, allowed = away_score) |>
  mutate(home_away = "home")

away_scored_allowed = end_games |>
  select(date, team = away_team, scored = away_score, allowed = home_score) |>
  mutate(home_away = "away")

team_scored_allowed = bind_rows(home_scored_allowed, away_scored_allowed) |>
  arrange(team, date)

team_rspg_rapg = team_scored_allowed |>
  group_by(team) |>
  summarise(rspg = sum(scored) / n(),
            rapg = sum(allowed) / n())

team_rspg_rapg |>
  inner_join(teams_info, by = "team") |>
  ggplot(aes(rspg, rapg)) +
  geom_point(aes(col = team), shape = "square", size = 4, show.legend = F) +
  geom_vline(xintercept = mean(team_rspg_rapg$rspg), linetype = "dashed", alpha = 0.5) +
  geom_hline(yintercept = mean(team_rspg_rapg$rapg), linetype = "dashed", alpha = 0.5) +
  scale_color_manual(values = team_hex) +
  ggrepel::geom_text_repel(aes(label = abb), size = 3, max.overlaps = 30) +
  labs(x = "Runs Scored per Game", y = "Runs Allowed Per Game",
       title = glue("Team Runs Scored/Allowed per Game as of {better_date(Sys.Date())}")) +
  scale_x_continuous(breaks = seq(0, 15, by = 1)) +
  scale_y_continuous(breaks = seq(0, 15, by = 1))
```

___

### NPR (in progress)

```{r include = F}
end_with_npr = end_games |>
  inner_join(team_rspg_rapg, by = c("home_team" = "team")) |>
  rename(home_rspg = rspg, home_rapg = rapg) |>
  inner_join(team_rspg_rapg, by = c("away_team" = "team")) |>
  rename(away_rspg = rspg, away_rapg = rapg) |>
  mutate(home_exp = (home_rspg + away_rapg) / 2,
         away_exp = (away_rspg + home_rapg) / 2,
         home_off_npr = home_score - home_exp,
         home_def_npr = away_exp - away_score,
         away_off_npr = away_score - away_exp,
         away_def_npr = home_exp - home_score)

home_npr_by_game = end_with_npr |>
  transmute(date, team = home_team, off_npr = home_off_npr, def_npr = home_def_npr, home_away = "home")

away_npr_by_game = end_with_npr |>
  transmute(date, team = away_team, off_npr = away_off_npr, def_npr = away_def_npr, home_away = "away")

team_npr_by_game = bind_rows(home_npr_by_game, away_npr_by_game) |>
  arrange(team, date)

# need everyone to have played multiple opponents for this to work
# team_npr_by_game |>
#   group_by(team) |>
#   summarise(off_npr = sum(off_npr),
#             def_npr = sum(def_npr),
#             ovr_npr = off_npr + def_npr)
```

___

### Run Differentials

```{r echo = F}
home_margins = end_games |>
  transmute(date, team = home_team, margin = home_score - away_score, home_away = "home")

away_margins = end_games |>
  transmute(date, team = away_team, margin = away_score - home_score, home_away = "away")

team_game_margins = bind_rows(home_margins, away_margins) |>
  arrange(team, date)

team_game_margins |>
  group_by(team) |>
  summarise(diff_per_game = sum(margin) / n()) |>
  inner_join(teams_info, by = "team") |>
  mutate(pl = ifelse(diff_per_game >= 0, round(diff_per_game, 2), ""),
         nl = ifelse(diff_per_game < 0, round(diff_per_game, 2), "")) |>
  ggplot(aes(reorder(abb, diff_per_game), diff_per_game)) +
  geom_col(aes(fill = team), show.legend = F) +
  geom_text(aes(label = pl), size = 3, hjust = -0.25) +
  geom_text(aes(label = nl), size = 3, hjust = 1.25) +
  coord_flip() +
  scale_fill_manual(values = team_hex) +
  labs(x = NULL, y = "Avg. run differential",
       title = glue("Team avg. run differentials as of {better_date(Sys.Date())}")) +
  scale_y_continuous(breaks = seq(-10, 10, by = 1))
```

___

### Pythagorean Wins

```{r echo = F}
team_pythag = team_scored_allowed |>
  group_by(team) |>
  summarise(scored = sum(scored),
            allowed = sum(allowed)) |>
  mutate(pythag = round(scored ^ 2 / (scored ^ 2 + allowed ^ 2) * 100, 1))

team_pythag |>
  ggplot(aes(reorder(team, pythag), pythag)) +
  geom_col(aes(fill = team), show.legend = F) +
  coord_flip(ylim = c(0, max(team_pythag$pythag) * 1.05)) +
  scale_fill_manual(values = team_hex) +
  geom_text(aes(label = paste0(pythag, "%")), size = 3, hjust = -0.15) +
  labs(x = NULL, y = "Pythagorean Win Percentage",
       title = glue("Team pythagorean win percentages as of {better_date(Sys.Date())}")) +
  scale_y_continuous(breaks = seq(0, 100, by = 10), labels = scales::percent_format(scale = 1))
```

___

### Actual vs Pythagorean Win Percentages

```{r echo = F}
team_records |>
  inner_join(team_pythag, by = "team") |>
  ggplot(aes(pythag, win_pct)) +
  geom_point(aes(col = team), shape = "square", size = 4, show.legend = F) +
  ggrepel::geom_text_repel(aes(label = abb), size = 3, max.overlaps = 30) +
  scale_color_manual(values = team_hex) +
  geom_vline(xintercept = 50, linetype = "dashed", alpha = 0.5) +
  geom_hline(yintercept = 50, linetype = "dashed", alpha = 0.5) +
  geom_abline(linetype = "dashed", alpha = 0.25) +
  scale_x_continuous(breaks = seq(0, 100, by = 10), labels = scales::percent_format(scale = 1)) +
  scale_y_continuous(breaks = seq(0, 100, by = 10), labels = scales::percent_format(scale = 1)) +
  labs(x = "Pythagorean Win Percentage (PWP)",
       y = "Actual Win Percentage",
       title = "Team pythagorean vs. actual win percentage",
       subtitle = "Teams above/below diagonal are worse/better than their record per PWP")
```

___

### Winning and Losing Streaks

```{r echo = F}
team_game_wl = end_games |>
  transmute(date, team = win_team, wl = "win") |>
  bind_rows(end_games |>
  transmute(date, team = lose_team, wl = "loss")) |>
  arrange(team, date)

team_wl_streaks = team_game_wl |>
  group_by(team) |>
  mutate(streak_group = cumsum(wl != lag(wl, default = first(wl))),
         streak = sequence(rle(wl)$lengths),
         streak_type = ifelse(wl == "win", "W", "L"),
         streak_pn = ifelse(streak_type == "W", streak, -streak)) |>
  slice_max(date, n = 1, with_ties = F) |>
  ungroup() |>
  mutate(team_streak = paste0(streak_type, streak))

team_wl_streaks |>
  mutate(pl = ifelse(streak_pn >= 0, team_streak, ""),
         nl = ifelse(streak_pn < 0, team_streak, "")) |>
  ggplot(aes(reorder(team, streak_pn), streak_pn)) +
  geom_col(aes(fill = team), show.legend = F) +
  geom_text(aes(label = pl), size = 3, hjust = -0.25) +
  geom_text(aes(label = nl), size = 3, hjust = 1.25) +
  coord_flip() +
  scale_fill_manual(values = team_hex) +
  scale_y_continuous(breaks = seq(-25, 25, by = 1)) +
  labs(x = NULL, y = "Winning/Losing Streak",
       title = glue("Team winning/losing streaks as of {better_date(Sys.Date())}"))
```

___

### More to come as the season goes on!

___

### Home and Away Splits

```{r}
# logic here
```

























































